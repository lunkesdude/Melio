<!-- melio-app.html -->
<!DOCTYPE html>
<html lang="ru" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Melio</title>
    <style>
        /* ============================================
           MELIO APP ‚Äî MAIN MESSENGER
           –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏ —Å—Ç–∏–ª—å 1:1 –∏–∑ melio-auth.html
           ============================================ */

        /* --- CSS Variables (–∫–æ–ø–∏—è –∏–∑ auth) --- */
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-tertiary: #1a1a2e;
            --bg-card: #16162a;
            --text-primary: #e8e8f0;
            --text-secondary: #8888a8;
            --text-muted: #555570;
            --accent-purple: #7c3aed;
            --accent-purple-light: #a855f7;
            --accent-cyan: #06b6d4;
            --accent-cyan-light: #22d3ee;
            --accent-gradient: linear-gradient(135deg, #7c3aed, #06b6d4);
            --accent-glow-purple: 0 0 20px rgba(124, 58, 237, 0.4);
            --accent-glow-cyan: 0 0 20px rgba(6, 182, 212, 0.4);
            --danger: #ef4444;
            --success: #22c55e;
            --warning: #f59e0b;
            --border-color: rgba(124, 58, 237, 0.2);
            --border-radius: 12px;
            --border-radius-sm: 8px;
            --border-radius-lg: 20px;
            --transition-fast: 0.2s ease;
            --transition-normal: 0.3s ease;
            --transition-slow: 0.5s ease;
            --font-main: 'Segoe UI', system-ui, -apple-system, sans-serif;
            --sidebar-width: 380px;
        }

        [data-theme="light"] {
            --bg-primary: #f0f0f5;
            --bg-secondary: #ffffff;
            --bg-tertiary: #e8e8f0;
            --bg-card: #ffffff;
            --text-primary: #1a1a2e;
            --text-secondary: #555570;
            --text-muted: #8888a8;
            --border-color: rgba(124, 58, 237, 0.15);
        }

        /* --- Reset (–∫–æ–ø–∏—è –∏–∑ auth) --- */
        *, *::before, *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            font-family: var(--font-main);
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow: hidden;
        }

        button {
            font-family: var(--font-main);
            cursor: pointer;
        }

        /* ============================================
           ANIMATED BACKGROUND (–∫–æ–ø–∏—è –∏–∑ auth)
           ============================================ */

        .app-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            overflow: hidden;
        }

        .app-bg::before {
            content: '';
            position: absolute;
            width: 600px;
            height: 600px;
            background: radial-gradient(circle, rgba(124,58,237,0.15) 0%, transparent 70%);
            top: -200px;
            left: -200px;
            animation: floatOrb1 15s ease-in-out infinite;
        }

        .app-bg::after {
            content: '';
            position: absolute;
            width: 500px;
            height: 500px;
            background: radial-gradient(circle, rgba(6,182,212,0.12) 0%, transparent 70%);
            bottom: -200px;
            right: -200px;
            animation: floatOrb2 18s ease-in-out infinite;
        }

        @keyframes floatOrb1 {
            0%, 100% { transform: translate(0, 0) scale(1); }
            33% { transform: translate(100px, 50px) scale(1.1); }
            66% { transform: translate(50px, 100px) scale(0.9); }
        }

        @keyframes floatOrb2 {
            0%, 100% { transform: translate(0, 0) scale(1); }
            33% { transform: translate(-80px, -60px) scale(1.15); }
            66% { transform: translate(-40px, -80px) scale(0.95); }
        }

        /* --- Grid Overlay (–∫–æ–ø–∏—è –∏–∑ auth) --- */
        .grid-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image:
                linear-gradient(rgba(124,58,237,0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(124,58,237,0.03) 1px, transparent 1px);
            background-size: 60px 60px;
            z-index: 0;
            pointer-events: none;
        }

        /* --- Particles (–∫–æ–ø–∏—è –∏–∑ auth) --- */
        .particle {
            position: fixed;
            width: 4px;
            height: 4px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 0;
            animation: particleFloat linear infinite;
        }

        @keyframes particleFloat {
            0% { opacity: 0; transform: translateY(100vh) scale(0); }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { opacity: 0; transform: translateY(-10vh) scale(1); }
        }

        /* ============================================
           TOAST NOTIFICATIONS (–∫–æ–ø–∏—è –∏–∑ auth)
           ============================================ */

        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            padding: 14px 20px;
            border-radius: var(--border-radius-sm);
            color: #fff;
            font-size: 14px;
            font-weight: 500;
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
            animation: toastIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 360px;
            backdrop-filter: blur(10px);
        }

        .toast.success {
            background: linear-gradient(135deg, rgba(34,197,94,0.9), rgba(22,163,74,0.9));
            border: 1px solid rgba(34,197,94,0.3);
        }

        .toast.error {
            background: linear-gradient(135deg, rgba(239,68,68,0.9), rgba(220,38,38,0.9));
            border: 1px solid rgba(239,68,68,0.3);
        }

        .toast.info {
            background: linear-gradient(135deg, rgba(124,58,237,0.9), rgba(6,182,212,0.9));
            border: 1px solid rgba(124,58,237,0.3);
        }

        .toast-exit {
            animation: toastOut 0.3s ease forwards;
        }

        @keyframes toastIn {
            0% { opacity: 0; transform: translateX(100px) scale(0.9); }
            100% { opacity: 1; transform: translateX(0) scale(1); }
        }

        @keyframes toastOut {
            0% { opacity: 1; transform: translateX(0); }
            100% { opacity: 0; transform: translateX(100px); }
        }

        /* ============================================
           APP LAYOUT
           ============================================ */

        .app-layout {
            display: flex;
            height: 100vh;
            position: relative;
            z-index: 1;
            opacity: 0;
            animation: layoutAppear 0.6s cubic-bezier(0.16, 1, 0.3, 1) 0.1s forwards;
        }

        @keyframes layoutAppear {
            0% {
                opacity: 0;
                transform: translateY(15px) scale(0.99);
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* ============================================
           SIDEBAR
           ============================================ */

        .sidebar {
            width: var(--sidebar-width);
            min-width: var(--sidebar-width);
            max-width: var(--sidebar-width);
            height: 100vh;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- Sidebar Top Bar (hamburger + search) --- */
        .sidebar-top {
            padding: 10px 10px 0;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .hamburger-btn {
            width: 44px;
            height: 44px;
            border-radius: var(--border-radius-sm);
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
            flex-shrink: 0;
        }

        .hamburger-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .hamburger-btn:active {
            transform: scale(0.93);
        }

        /* --- Search Box --- */
        .search-box {
            flex: 1;
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 11px 14px 11px 38px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            color: var(--text-primary);
            font-size: 14px;
            font-family: var(--font-main);
            outline: none;
            transition: all var(--transition-fast);
        }

        .search-box input::placeholder {
            color: var(--text-muted);
        }

        .search-box input:focus {
            border-color: var(--accent-purple);
            box-shadow: 0 0 0 3px rgba(124,58,237,0.15);
        }

        .search-box .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 14px;
            color: var(--text-muted);
            pointer-events: none;
        }

        .search-box .search-clear {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 14px;
            display: none;
            padding: 4px;
            transition: color var(--transition-fast);
        }

        .search-box .search-clear.visible {
            display: block;
        }

        .search-box .search-clear:hover {
            color: var(--accent-purple-light);
        }

        /* --- Folder Tabs --- */
        .folder-tabs {
            display: flex;
            padding: 10px 10px 0;
            gap: 2px;
            flex-shrink: 0;
        }

        .folder-tab {
            flex: 1;
            padding: 10px 6px;
            text-align: center;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            background: none;
            border: none;
            border-radius: var(--border-radius-sm) var(--border-radius-sm) 0 0;
            transition: all var(--transition-fast);
            position: relative;
            letter-spacing: 0.3px;
        }

        .folder-tab:hover {
            color: var(--text-secondary);
            background: var(--bg-tertiary);
        }

        .folder-tab.active {
            color: var(--text-primary);
        }

        .folder-tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 20%;
            right: 20%;
            height: 2px;
            background: var(--accent-gradient);
            border-radius: 2px;
            box-shadow: var(--accent-glow-purple);
        }

        .folder-tab .tab-count {
            font-size: 10px;
            margin-left: 4px;
            color: var(--text-muted);
            font-weight: 500;
        }

        .folder-tab.active .tab-count {
            color: var(--accent-purple-light);
        }

        /* Tabs divider */
        .tabs-line {
            height: 1px;
            background: var(--border-color);
            flex-shrink: 0;
        }

        /* ============================================
           CHAT LIST
           ============================================ */

        .chat-scroll {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .chat-scroll::-webkit-scrollbar {
            width: 5px;
        }

        .chat-scroll::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-scroll::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        .chat-scroll::-webkit-scrollbar-thumb:hover {
            background: rgba(124,58,237,0.35);
        }

        /* --- Chat Item --- */
        .chat-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 14px;
            cursor: pointer;
            transition: background var(--transition-fast);
            position: relative;
            /* stagger animation */
            opacity: 0;
            transform: translateY(8px);
            animation: chatItemIn 0.35s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        @keyframes chatItemIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .chat-item:hover {
            background: var(--bg-tertiary);
        }

        .chat-item:active {
            background: var(--bg-card);
        }

        .chat-item.active {
            background: var(--bg-card);
        }

        .chat-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 8px;
            bottom: 8px;
            width: 3px;
            background: var(--accent-gradient);
            border-radius: 0 3px 3px 0;
        }

        /* --- Avatar --- */
        .avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--accent-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 19px;
            font-weight: 700;
            color: #fff;
            flex-shrink: 0;
            position: relative;
            text-transform: uppercase;
        }

        .avatar-sm {
            width: 38px;
            height: 38px;
            font-size: 14px;
        }

        .avatar-lg {
            width: 60px;
            height: 60px;
            font-size: 24px;
        }

        .avatar.channel-av {
            background: linear-gradient(135deg, #06b6d4, #7c3aed);
            font-size: 22px;
        }

        .avatar.group-av {
            background: linear-gradient(135deg, #f472b6, #7c3aed);
            font-size: 20px;
        }

        .avatar.plus-ring {
            box-shadow:
                0 0 0 2px var(--bg-secondary),
                0 0 0 4px var(--accent-purple);
        }

        /* Online dot */
        .online-dot {
            position: absolute;
            bottom: 1px;
            right: 1px;
            width: 13px;
            height: 13px;
            border-radius: 50%;
            border: 2.5px solid var(--bg-secondary);
        }

        .online-dot.on {
            background: var(--success);
        }

        .online-dot.off {
            background: var(--text-muted);
        }

        /* --- Chat Body --- */
        .chat-body {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .chat-row-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chat-name {
            font-size: 15px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
            min-width: 0;
        }

        .chat-name .name-text {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .verified-badge {
            width: 16px;
            height: 16px;
            flex-shrink: 0;
        }

        .plus-badge {
            font-size: 8px;
            padding: 1px 5px;
            background: var(--accent-gradient);
            border-radius: 8px;
            color: #fff;
            font-weight: 700;
            letter-spacing: 0.3px;
            flex-shrink: 0;
            box-shadow: var(--accent-glow-purple);
        }

        .chat-time {
            font-size: 12px;
            color: var(--text-muted);
            flex-shrink: 0;
            margin-left: 8px;
        }

        .chat-row-bottom {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }

        .chat-preview {
            font-size: 14px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
            min-width: 0;
        }

        .chat-preview .sender-label {
            color: var(--accent-purple-light);
            font-weight: 600;
        }

        .msg-status {
            font-size: 14px;
            flex-shrink: 0;
            color: var(--text-muted);
        }

        .msg-status.seen {
            color: var(--accent-cyan-light);
        }

        /* --- Empty State --- */
        .empty-msg {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
            font-size: 14px;
        }

        .empty-msg .empty-icon {
            font-size: 32px;
            margin-bottom: 10px;
            display: block;
        }

        /* ============================================
           SKELETON LOADER
           ============================================ */

        .skel-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 14px;
        }

        .skel {
            background: linear-gradient(
                90deg,
                var(--bg-tertiary) 25%,
                var(--bg-card) 50%,
                var(--bg-tertiary) 75%
            );
            background-size: 200% 100%;
            animation: shimmer 1.5s ease-in-out infinite;
            border-radius: var(--border-radius-sm);
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        .skel-circle {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .skel-lines {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .skel-line {
            height: 13px;
            border-radius: 6px;
        }

        .skel-w55 { width: 55%; }
        .skel-w80 { width: 80%; }
        .skel-w40 { width: 40%; }
        .skel-w65 { width: 65%; }

        /* ============================================
           SLIDE MENU (hamburger panel)
           ============================================ */

        .menu-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.45);
            z-index: 50;
            opacity: 0;
            transition: opacity var(--transition-normal);
        }

        .menu-overlay.visible {
            display: block;
            opacity: 1;
        }

        .slide-menu {
            position: fixed;
            top: 0;
            left: 0;
            width: 300px;
            height: 100vh;
            background: var(--bg-card);
            border-right: 1px solid var(--border-color);
            z-index: 51;
            display: flex;
            flex-direction: column;
            transform: translateX(-100%);
            transition: transform 0.35s cubic-bezier(0.16, 1, 0.3, 1);
            box-shadow:
                0 0 60px rgba(0,0,0,0.5),
                0 0 40px rgba(124,58,237,0.08);
        }

        .slide-menu.open {
            transform: translateX(0);
        }

        /* Menu header */
        .menu-header {
            padding: 24px 20px 18px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 12px;
            background: var(--bg-tertiary);
        }

        .menu-avatar {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--accent-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            font-weight: 800;
            color: #fff;
        }

        .menu-avatar.plus-ring {
            box-shadow:
                0 0 0 2px var(--bg-tertiary),
                0 0 0 4px var(--accent-purple);
        }

        .menu-user-name {
            font-size: 16px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
        }

        .menu-user-sub {
            font-size: 12px;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .menu-crystals {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            color: var(--accent-cyan-light);
            font-weight: 600;
        }

        /* Menu items */
        .menu-items {
            flex: 1;
            padding: 8px;
            overflow-y: auto;
        }

        .menu-item {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 12px 16px;
            border-radius: var(--border-radius-sm);
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 500;
            width: 100%;
            text-align: left;
            transition: all var(--transition-fast);
        }

        .menu-item:hover {
            background: var(--bg-tertiary);
        }

        .menu-item:active {
            transform: scale(0.98);
        }

        .menu-item .mi-icon {
            font-size: 18px;
            width: 26px;
            text-align: center;
        }

        .menu-item.danger {
            color: var(--danger);
        }

        .menu-item.danger:hover {
            background: rgba(239,68,68,0.08);
        }

        .menu-sep {
            height: 1px;
            background: var(--border-color);
            margin: 6px 16px;
        }

        .menu-label {
            padding: 10px 16px 4px;
            font-size: 10px;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Theme toggle */
        .theme-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            transition: background var(--transition-fast);
        }

        .theme-row:hover {
            background: var(--bg-tertiary);
        }

        .theme-row-left {
            display: flex;
            align-items: center;
            gap: 14px;
            font-size: 14px;
            font-weight: 500;
        }

        .theme-row-left .mi-icon {
            font-size: 18px;
            width: 26px;
            text-align: center;
        }

        .toggle-track {
            width: 40px;
            height: 22px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 11px;
            position: relative;
            transition: all var(--transition-fast);
        }

        .toggle-track::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--text-muted);
            transition: all var(--transition-normal);
        }

        .toggle-track.on {
            background: var(--accent-purple);
            border-color: var(--accent-purple);
        }

        .toggle-track.on::after {
            left: 20px;
            background: #fff;
        }

        /* Menu footer */
        .menu-footer {
            padding: 14px 20px;
            border-top: 1px solid var(--border-color);
            font-size: 11px;
            color: var(--text-muted);
            letter-spacing: 0.5px;
            text-align: center;
        }

        /* New chat button in menu */
        .new-chat-btn {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 12px 16px;
            border-radius: var(--border-radius-sm);
            background: none;
            border: none;
            color: var(--accent-purple-light);
            font-size: 14px;
            font-weight: 600;
            width: 100%;
            text-align: left;
            transition: all var(--transition-fast);
        }

        .new-chat-btn:hover {
            background: rgba(124,58,237,0.08);
        }

        .new-chat-btn:active {
            transform: scale(0.98);
        }

        .new-chat-btn .mi-icon {
            font-size: 18px;
            width: 26px;
            text-align: center;
        }

        /* ============================================
           MAIN AREA (right side ‚Äî welcome screen)
           ============================================ */

        .main-area {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-primary);
        }

        .welcome-box {
            text-align: center;
            opacity: 0;
            animation: welcomeAppear 0.6s cubic-bezier(0.16, 1, 0.3, 1) 0.3s forwards;
        }

        @keyframes welcomeAppear {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.97);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .welcome-logo {
            font-size: 56px;
            font-weight: 800;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -2px;
            margin-bottom: 8px;
            display: inline-block;
            position: relative;
        }

        .welcome-logo::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 50%;
            transform: translateX(-50%);
            width: 50px;
            height: 3px;
            background: var(--accent-gradient);
            border-radius: 2px;
        }

        .welcome-title {
            font-size: 16px;
            color: var(--text-secondary);
            margin-top: 16px;
        }

        .welcome-sub {
            font-size: 13px;
            color: var(--text-muted);
            margin-top: 6px;
        }

        .welcome-cards {
            display: flex;
            gap: 14px;
            margin-top: 32px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .w-card {
            width: 110px;
            padding: 16px 10px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            text-align: center;
            transition: all var(--transition-fast);
            box-shadow:
                0 8px 24px rgba(0,0,0,0.3),
                inset 0 1px 0 rgba(255,255,255,0.05);
        }

        .w-card:hover {
            border-color: var(--accent-purple);
            transform: translateY(-2px);
            box-shadow:
                var(--accent-glow-purple),
                0 12px 30px rgba(0,0,0,0.3);
        }

        .w-card .wc-icon {
            font-size: 24px;
            margin-bottom: 6px;
            display: block;
        }

        .w-card .wc-text {
            font-size: 11px;
            color: var(--text-secondary);
            font-weight: 600;
        }

        /* ============================================
           MODAL ‚Äî New Chat (—Å—Ç–∏–ª—å –∫–∞–∫ auth-card)
           ============================================ */

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(6px);
            z-index: 200;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.visible {
            display: flex;
        }

        .modal-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-lg);
            padding: 32px;
            width: 90%;
            max-width: 440px;
            box-shadow:
                0 25px 60px rgba(0,0,0,0.5),
                0 0 40px rgba(124,58,237,0.08),
                inset 0 1px 0 rgba(255,255,255,0.05);
            backdrop-filter: blur(20px);
            animation: cardAppear 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes cardAppear {
            0% {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border-radius: var(--border-radius-sm);
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            color: var(--text-muted);
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
        }

        .modal-close:hover {
            border-color: var(--danger);
            color: var(--danger);
            transform: translateY(-2px);
        }

        .modal-close:active {
            transform: translateY(0);
        }

        /* Modal user list */
        .modal-user-list {
            max-height: 320px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .modal-user-list::-webkit-scrollbar {
            width: 4px;
        }

        .modal-user-list::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        .modal-user-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            border-radius: var(--border-radius-sm);
            border: none;
            background: none;
            color: var(--text-primary);
            font-family: var(--font-main);
            font-size: 14px;
            width: 100%;
            text-align: left;
            transition: background var(--transition-fast);
        }

        .modal-user-item:hover {
            background: var(--bg-tertiary);
        }

        .modal-user-item:active {
            transform: scale(0.99);
        }

        .mu-info {
            flex: 1;
            min-width: 0;
        }

        .mu-name {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .mu-sub {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 1px;
        }

        /* ============================================
           VERSION BADGE
           ============================================ */

        .version-badge {
            position: fixed;
            bottom: 16px;
            right: 16px;
            font-size: 11px;
            color: var(--text-muted);
            letter-spacing: 1px;
            z-index: 1;
        }

        /* ============================================
           RESPONSIVE
           ============================================ */

        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                min-width: 100%;
                max-width: 100%;
            }
            .main-area {
                display: none;
            }
        }
    </style>
</head>
<body>

    <!-- Background (–∫–æ–ø–∏—è –∏–∑ auth) -->
    <div class="app-bg"></div>
    <div class="grid-overlay"></div>

    <!-- Toast -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Version -->
    <div class="version-badge">MELIO v1.0.0</div>

    <!-- =============================================
         SLIDE MENU (hamburger)
         ============================================= -->

    <div class="menu-overlay" id="menuOverlay" onclick="closeMenu()"></div>

    <div class="slide-menu" id="slideMenu">

        <!-- Menu Header: user info -->
        <div class="menu-header">
            <div class="menu-avatar" id="menuAvatar">?</div>
            <div class="menu-user-name" id="menuUserName">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            <div class="menu-user-sub">
                <span id="menuRole">‚è≥</span>
                <span class="menu-crystals">üíé <span id="menuCrystals">0</span></span>
            </div>
        </div>

        <!-- Menu Items -->
        <div class="menu-items">

            <button class="new-chat-btn" onclick="openNewChatModal()">
                <span class="mi-icon">‚úèÔ∏è</span> –ù–æ–≤—ã–π —á–∞—Ç
            </button>

            <div class="menu-sep"></div>

            <button class="menu-item" onclick="goTo('melio-profile.html')">
                <span class="mi-icon">üë§</span> –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å
            </button>
            <button class="menu-item" onclick="goTo('melio-rewards.html')">
                <span class="mi-icon">üèÜ</span> –ù–∞–≥—Ä–∞–¥—ã –∏ –∞—á–∏–≤–∫–∏
            </button>
            <button class="menu-item" onclick="goTo('melio-nft.html')">
                <span class="mi-icon">üéÅ</span> NFT –ü–æ–¥–∞—Ä–∫–∏
            </button>
            <button class="menu-item" onclick="goTo('melio-settings.html')">
                <span class="mi-icon">‚öôÔ∏è</span> –ù–∞—Å—Ç—Ä–æ–π–∫–∏
            </button>

            <div class="menu-sep"></div>

            <!-- Theme Toggle -->
            <div class="theme-row" onclick="toggleTheme()">
                <div class="theme-row-left">
                    <span class="mi-icon" id="themeIcon">üåô</span>
                    <span id="themeText">–¢—ë–º–Ω–∞—è —Ç–µ–º–∞</span>
                </div>
                <div class="toggle-track" id="themeToggle"></div>
            </div>

            <div class="menu-sep"></div>

            <!-- Admin (hidden by default) -->
            <div class="menu-label" id="adminLabel" style="display:none">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ</div>
            <button class="menu-item" id="adminBtn" style="display:none" onclick="goTo('melio-admin.html')">
                <span class="mi-icon">üõ°Ô∏è</span> –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
            </button>
            <div class="menu-sep" id="adminSep" style="display:none"></div>

            <!-- Logout -->
            <button class="menu-item danger" onclick="handleLogout()">
                <span class="mi-icon">üö™</span> –í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞
            </button>
        </div>

        <!-- Footer -->
        <div class="menu-footer">MELIO v1.0.0</div>
    </div>

    <!-- =============================================
         APP LAYOUT
         ============================================= -->

    <div class="app-layout">

        <!-- ========== SIDEBAR ========== -->
        <aside class="sidebar">

            <!-- Top bar -->
            <div class="sidebar-top">
                <button class="hamburger-btn" onclick="openMenu()" title="–ú–µ–Ω—é">‚ò∞</button>
                <div class="search-box">
                    <span class="search-icon">üîç</span>
                    <input
                        type="text"
                        id="searchInput"
                        placeholder="–ü–æ–∏—Å–∫..."
                        oninput="onSearch(this.value)"
                        autocomplete="off"
                    >
                    <button class="search-clear" id="searchClear" onclick="clearSearch()">‚úï</button>
                </div>
            </div>

            <!-- Folder tabs -->
            <div class="folder-tabs" id="folderTabs">
                <button class="folder-tab active" data-folder="all" onclick="setFolder('all')">–í—Å–µ</button>
                <button class="folder-tab" data-folder="private" onclick="setFolder('private')">–õ–∏—á–Ω—ã–µ</button>
                <button class="folder-tab" data-folder="group" onclick="setFolder('group')">–ì—Ä—É–ø–ø—ã</button>
                <button class="folder-tab" data-folder="channel" onclick="setFolder('channel')">–ö–∞–Ω–∞–ª—ã</button>
            </div>
            <div class="tabs-line"></div>

            <!-- Chat list -->
            <div class="chat-scroll" id="chatScroll">

                <!-- Skeleton -->
                <div id="skeleton">
                    <div class="skel-item">
                        <div class="skel skel-circle"></div>
                        <div class="skel-lines">
                            <div class="skel skel-line skel-w55"></div>
                            <div class="skel skel-line skel-w80"></div>
                        </div>
                    </div>
                    <div class="skel-item">
                        <div class="skel skel-circle"></div>
                        <div class="skel-lines">
                            <div class="skel skel-line skel-w40"></div>
                            <div class="skel skel-line skel-w65"></div>
                        </div>
                    </div>
                    <div class="skel-item">
                        <div class="skel skel-circle"></div>
                        <div class="skel-lines">
                            <div class="skel skel-line skel-w65"></div>
                            <div class="skel skel-line skel-w40"></div>
                        </div>
                    </div>
                    <div class="skel-item">
                        <div class="skel skel-circle"></div>
                        <div class="skel-lines">
                            <div class="skel skel-line skel-w55"></div>
                            <div class="skel skel-line skel-w80"></div>
                        </div>
                    </div>
                    <div class="skel-item">
                        <div class="skel skel-circle"></div>
                        <div class="skel-lines">
                            <div class="skel skel-line skel-w40"></div>
                            <div class="skel skel-line skel-w55"></div>
                        </div>
                    </div>
                </div>

                <!-- Actual chat list rendered by JS -->
                <div id="chatListArea"></div>
            </div>

        </aside>

        <!-- ========== MAIN AREA ========== -->
        <main class="main-area">
            <div class="welcome-box">
                <div class="welcome-logo">Melio </div>
                <div class="welcome-title">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å</div>
                <div class="welcome-sub">–ò–ª–∏ –Ω–∞–∂–º–∏—Ç–µ ‚ò∞ ‚Üí –ù–æ–≤—ã–π —á–∞—Ç</div>
                <div class="welcome-cards">
                    <div class="w-card">
                        <span class="wc-icon">üîí</span>
                        <span class="wc-text">–ü—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å</span>
                    </div>
                    <div class="w-card">
                        <span class="wc-icon">üíé</span>
                        <span class="wc-text">–ö—Ä–∏—Å—Ç–∞–ª–ª—ã</span>
                    </div>
                    <div class="w-card">
                        <span class="wc-icon">üéÅ</span>
                        <span class="wc-text">NFT</span>
                    </div>
                    <div class="w-card">
                        <span class="wc-icon">üèÜ</span>
                        <span class="wc-text">–ù–∞–≥—Ä–∞–¥—ã</span>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- =============================================
         MODAL: NEW CHAT
         ============================================= -->

    <div class="modal-overlay" id="newChatOverlay">
        <div class="modal-card">
            <div class="modal-header">
                <div class="modal-title">‚úèÔ∏è –ù–æ–≤—ã–π —á–∞—Ç</div>
                <button class="modal-close" onclick="closeNewChatModal()">‚úï</button>
            </div>

            <!-- Search inside modal -->
            <div style="margin-bottom: 16px;">
                <div class="search-box">
                    <span class="search-icon">üîç</span>
                    <input
                        type="text"
                        id="modalSearchInput"
                        placeholder="–ù–∞–π—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è..."
                        oninput="filterModalUsers(this.value)"
                        autocomplete="off"
                    >
                </div>
            </div>

            <div class="modal-user-list" id="modalUserList">
                <!-- filled by JS -->
            </div>
        </div>
    </div>

    <!-- =============================================
         JAVASCRIPT
         ============================================= -->

    <script>
        /* ============================================
           API LAYER (localStorage ‚Üí future server)
           ============================================ */

        const api = {
            async getSession() {
                const s = JSON.parse(localStorage.getItem('melio_session') || '{}');
                if (!s.loggedIn) return null;
                const users = JSON.parse(localStorage.getItem('melio_users') || '[]');
                return users.find(u => u.id === s.userId) || null;
            },

            async getAllUsers() {
                return JSON.parse(localStorage.getItem('melio_users') || '[]');
            },

            async getChats(userId) {
                const chats = JSON.parse(localStorage.getItem('melio_chats') || '[]');
                return chats.filter(c => c.members && c.members.includes(userId));
            },

            async createChat({ type, name, members }) {
                const chats = JSON.parse(localStorage.getItem('melio_chats') || '[]');
                // Prevent duplicate private chats
                if (type === 'private') {
                    const existing = chats.find(c =>
                        c.type === 'private' &&
                        c.members.length === 2 &&
                        members.every(m => c.members.includes(m))
                    );
                    if (existing) return existing;
                }
                const chat = {
                    id: 'chat_' + Date.now().toString(36) + Math.random().toString(36).substr(2, 5),
                    type: type,
                    name: name || null,
                    members: members,
                    lastMessage: null,
                    createdAt: new Date().toISOString()
                };
                chats.push(chat);
                localStorage.setItem('melio_chats', JSON.stringify(chats));
                return chat;
            },

            async logout() {
                const s = JSON.parse(localStorage.getItem('melio_session') || '{}');
                if (s.userId) {
                    const users = JSON.parse(localStorage.getItem('melio_users') || '[]');
                    const u = users.find(x => x.id === s.userId);
                    if (u) {
                        u.online = false;
                        localStorage.setItem('melio_users', JSON.stringify(users));
                    }
                }
                localStorage.removeItem('melio_session');
            }
        };

        /* ============================================
           ENSURE LUNKES + MELIO NEWS CHANNEL
           ============================================ */

        function ensureSpecialData() {
            let users = JSON.parse(localStorage.getItem('melio_users') || '[]');
            let chats = JSON.parse(localStorage.getItem('melio_chats') || '[]');
            let msgs = JSON.parse(localStorage.getItem('melio_messages') || '[]');
            let changed = false;

            // --- Create Lunkes if not exists ---
            if (!users.find(u => u.id === 'id_lunkes')) {
                users.push({
                    id: 'id_lunkes',
                    name: 'Lunkes',
                    username: 'Lunkes',
                    password: 'Lunkes009',
                    role: 'superadmin',
                    avatar: null,
                    verified: true,
                    profileAnimation: 'rotate-pop',
                    profileBg: { type: 'color', value: '#0a0618' },
                    melioPlus: true,
                    crystals: 50000,
                    rewards: [
                        {
                            id: 'rw_lunkes_1',
                            title: '–°–æ–∑–¥–∞—Ç–µ–ª—å Melio',
                            description: '–û—Å–Ω–æ–≤–∞—Ç–µ–ª—å –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–∞ Melio',
                            grantedBy: 'id_lunkes',
                            grantedAt: new Date().toISOString()
                        }
                    ],
                    achievements: [
                        {
                            id: 'ach_lunkes_1',
                            level: 10,
                            text: '–°–æ–∑–¥–∞—Ç–µ–ª—å –≤—Å–µ–ª–µ–Ω–Ω–æ–π Melio',
                            grantedBy: 'id_lunkes',
                            grantedAt: new Date().toISOString()
                        }
                    ],
                    nftGifts: ['nft_1', 'nft_2'],
                    createdAt: new Date().toISOString(),
                    online: false
                });
                changed = true;
            }

            // --- Create Melio News channel if not exists ---
            if (!chats.find(c => c.id === 'chat_melio_news')) {
                const channel = {
                    id: 'chat_melio_news',
                    type: 'channel',
                    name: 'Melio News',
                    channelUsername: 'Melio',
                    ownerId: 'id_lunkes',
                    members: users.map(u => u.id),
                    lastMessage: null,
                    createdAt: new Date().toISOString()
                };

                const newsMsgs = [
                    {
                        id: 'mn_1',
                        chatId: 'chat_melio_news',
                        senderId: 'id_lunkes',
                        text: 'üöÄ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Melio News! –ó–¥–µ—Å—å –≤—Å–µ –Ω–æ–≤–æ—Å—Ç–∏.',
                        status: 'seen',
                        createdAt: new Date(Date.now() - 86400000).toISOString(),
                        deleted: false
                    },
                    {
                        id: 'mn_2',
                        chatId: 'chat_melio_news',
                        senderId: 'id_lunkes',
                        text: 'üíé –°–∏—Å—Ç–µ–º–∞ –∫—Ä–∏—Å—Ç–∞–ª–ª–æ–≤ –∑–∞–ø—É—â–µ–Ω–∞!',
                        status: 'seen',
                        createdAt: new Date(Date.now() - 43200000).toISOString(),
                        deleted: false
                    },
                    {
                        id: 'mn_3',
                        chatId: 'chat_melio_news',
                        senderId: 'id_lunkes',
                        text: 'üéÅ NFT-–ø–æ–¥–∞—Ä–∫–∏ —É–∂–µ –¥–æ—Å—Ç—É–ø–Ω—ã!',
                        status: 'seen',
                        createdAt: new Date(Date.now() - 3600000).toISOString(),
                        deleted: false
                    }
                ];

                msgs.push(...newsMsgs);
                channel.lastMessage = newsMsgs[newsMsgs.length - 1];
                chats.push(channel);
                changed = true;
            }

            if (changed) {
                localStorage.setItem('melio_users', JSON.stringify(users));
                localStorage.setItem('melio_chats', JSON.stringify(chats));
                localStorage.setItem('melio_messages', JSON.stringify(msgs));
            }
        }

        /* ============================================
           GLOBAL STATE
           ============================================ */

        let currentUser = null;
        let allUsers = [];
        let myChats = [];
        let activeFolder = 'all';

        /* ============================================
           UTILITY FUNCTIONS
           ============================================ */

        function goTo(page) {
            closeMenu();
            window.location.href = page;
        }

        function getInitials(name) {
            if (!name) return '?';
            return name
                .split(' ')
                .map(w => w[0])
                .join('')
                .toUpperCase()
                .slice(0, 2);
        }

        function timeAgo(isoString) {
            if (!isoString) return '';
            const seconds = Math.floor((Date.now() - new Date(isoString).getTime()) / 1000);
            if (seconds < 60) return '—Å–µ–π—á–∞—Å';
            if (seconds < 3600) return Math.floor(seconds / 60) + ' –º–∏–Ω';
            if (seconds < 86400) return Math.floor(seconds / 3600) + ' —á';
            if (seconds < 604800) return Math.floor(seconds / 86400) + ' –¥';
            return new Date(isoString).toLocaleDateString('ru-RU', {
                day: 'numeric',
                month: 'short'
            });
        }

        /* --- Toast (–∫–æ–ø–∏—è –∏–∑ auth) --- */
        function showToast(message, type, duration) {
            type = type || 'info';
            duration = duration || 3000;
            var container = document.getElementById('toastContainer');
            var toast = document.createElement('div');
            toast.className = 'toast ' + type;
            var icons = { success: '‚úÖ', error: '‚ùå', info: 'üíé' };
            toast.innerHTML =
                '<span>' + (icons[type] || 'üíé') + '</span>' +
                '<span>' + message + '</span>';
            container.appendChild(toast);
            setTimeout(function () {
                toast.classList.add('toast-exit');
                setTimeout(function () {
                    toast.remove();
                }, 300);
            }, duration);
        }

        /* --- Particles (–∫–æ–ø–∏—è –∏–∑ auth) --- */
        function createParticles() {
            var colors = ['#7c3aed', '#06b6d4', '#a855f7', '#22d3ee'];
            for (var i = 0; i < 20; i++) {
                var particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + 'vw';
                particle.style.background = colors[Math.floor(Math.random() * colors.length)];
                particle.style.animationDuration = (8 + Math.random() * 12) + 's';
                particle.style.animationDelay = Math.random() * 10 + 's';
                var size = 2 + Math.random() * 4;
                particle.style.width = size + 'px';
                particle.style.height = size + 'px';
                particle.style.opacity = 0.3 + Math.random() * 0.4;
                document.body.appendChild(particle);
            }
        }

        /* ============================================
           SLIDE MENU
           ============================================ */

        function openMenu() {
            document.getElementById('slideMenu').classList.add('open');
            document.getElementById('menuOverlay').classList.add('visible');
        }

        function closeMenu() {
            document.getElementById('slideMenu').classList.remove('open');
            document.getElementById('menuOverlay').classList.remove('visible');
        }

        function renderMenu() {
            if (!currentUser) return;

            // Avatar
            var avatarEl = document.getElementById('menuAvatar');
            avatarEl.textContent = getInitials(currentUser.name);
            if (currentUser.melioPlus) {
                avatarEl.classList.add('plus-ring');
            }

            // Name + badges
            var nameHTML = currentUser.name;
            if (currentUser.verified) {
                nameHTML += ' <img src="https://cdn3d.iconscout.com/3d/premium/thumb/tick-3d-icon-png-download-10199917.png" class="verified-badge" alt="‚úì">';
            }
            if (currentUser.melioPlus) {
                nameHTML += ' <span class="plus-badge">PLUS</span>';
            }
            document.getElementById('menuUserName').innerHTML = nameHTML;

            // Role
            var roleMap = {
                user: 'üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
                admin: 'üõ°Ô∏è –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä',
                superadmin: 'üëë –°—É–ø–µ—Ä-–ê–¥–º–∏–Ω'
            };
            document.getElementById('menuRole').textContent =
                roleMap[currentUser.role] || roleMap.user;

            // Crystals
            document.getElementById('menuCrystals').textContent =
                currentUser.crystals.toLocaleString();

            // Admin items
            if (currentUser.role === 'admin' || currentUser.role === 'superadmin') {
                document.getElementById('adminBtn').style.display = 'flex';
                document.getElementById('adminLabel').style.display = 'block';
                document.getElementById('adminSep').style.display = 'block';
            }
        }

        /* ============================================
           THEME
           ============================================ */

        function loadTheme() {
            var theme = localStorage.getItem('melio_theme') || 'dark';
            document.documentElement.setAttribute('data-theme', theme);
            updateThemeUI(theme);
        }

        function toggleTheme() {
            var current = document.documentElement.getAttribute('data-theme');
            var next = current === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', next);
            localStorage.setItem('melio_theme', next);
            updateThemeUI(next);
        }

        function updateThemeUI(theme) {
            var toggle = document.getElementById('themeToggle');
            var icon = document.getElementById('themeIcon');
            var text = document.getElementById('themeText');
            if (theme === 'dark') {
                toggle.classList.add('on');
                icon.textContent = 'üåô';
                text.textContent = '–¢—ë–º–Ω–∞—è —Ç–µ–º–∞';
            } else {
                toggle.classList.remove('on');
                icon.textContent = '‚òÄÔ∏è';
                text.textContent = '–°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞';
            }
        }

        /* ============================================
           FOLDER TABS
           ============================================ */

        function setFolder(folder) {
            activeFolder = folder;
            // Update active tab
            var tabs = document.querySelectorAll('.folder-tab');
            for (var i = 0; i < tabs.length; i++) {
                var tab = tabs[i];
                if (tab.getAttribute('data-folder') === folder) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            }
            renderChatList();
        }

        function updateTabCounts() {
            var counts = { all: myChats.length, private: 0, group: 0, channel: 0 };
            for (var i = 0; i < myChats.length; i++) {
                var type = myChats[i].type;
                if (counts[type] !== undefined) {
                    counts[type]++;
                }
            }
            var tabs = document.querySelectorAll('.folder-tab');
            for (var j = 0; j < tabs.length; j++) {
                var tab = tabs[j];
                var folder = tab.getAttribute('data-folder');
                // Remove old count
                var old = tab.querySelector('.tab-count');
                if (old) old.remove();
                // Add new
                if (counts[folder] > 0) {
                    var span = document.createElement('span');
                    span.className = 'tab-count';
                    span.textContent = counts[folder];
                    tab.appendChild(span);
                }
            }
        }

        /* ============================================
           CHAT LIST RENDERING
           ============================================ */

        function getChatDisplayName(chat) {
            if (chat.type === 'channel') return chat.name || '–ö–∞–Ω–∞–ª';
            if (chat.type === 'group') return chat.name || '–ì—Ä—É–ø–ø–∞';
            // Private ‚Äî show other user name
            var otherId = null;
            for (var i = 0; i < chat.members.length; i++) {
                if (chat.members[i] !== currentUser.id) {
                    otherId = chat.members[i];
                    break;
                }
            }
            var otherUser = null;
            for (var j = 0; j < allUsers.length; j++) {
                if (allUsers[j].id === otherId) {
                    otherUser = allUsers[j];
                    break;
                }
            }
            return otherUser ? otherUser.name : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π';
        }

        function getChatOtherUser(chat) {
            if (chat.type !== 'private') return null;
            var otherId = null;
            for (var i = 0; i < chat.members.length; i++) {
                if (chat.members[i] !== currentUser.id) {
                    otherId = chat.members[i];
                    break;
                }
            }
            for (var j = 0; j < allUsers.length; j++) {
                if (allUsers[j].id === otherId) return allUsers[j];
            }
            return null;
        }

        function findUserById(id) {
            for (var i = 0; i < allUsers.length; i++) {
                if (allUsers[i].id === id) return allUsers[i];
            }
            return null;
        }

        function renderChatList(searchFilter) {
            searchFilter = searchFilter || '';
            var area = document.getElementById('chatListArea');
            area.innerHTML = '';

            // Filter by folder
            var filtered = [];
            for (var i = 0; i < myChats.length; i++) {
                var chat = myChats[i];
                if (activeFolder !== 'all' && chat.type !== activeFolder) continue;
                // Search filter
                if (searchFilter) {
                    var name = getChatDisplayName(chat);
                    if (name.toLowerCase().indexOf(searchFilter.toLowerCase()) === -1) continue;
                }
                filtered.push(chat);
            }

            // Sort by last message time
            filtered.sort(function (a, b) {
                var ta = a.lastMessage
                    ? new Date(a.lastMessage.createdAt).getTime()
                    : new Date(a.createdAt).getTime();
                var tb = b.lastMessage
                    ? new Date(b.lastMessage.createdAt).getTime()
                    : new Date(b.createdAt).getTime();
                return tb - ta;
            });

            // Update tab counts
            updateTabCounts();

            // Empty state
            if (filtered.length === 0) {
                area.innerHTML =
                    '<div class="empty-msg">' +
                    '<span class="empty-icon">üí¨</span>' +
                    '–ß–∞—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç' +
                    '</div>';
                return;
            }

            // Render items
            for (var k = 0; k < filtered.length; k++) {
                area.appendChild(buildChatItem(filtered[k], k));
            }

            // Hide skeleton
            var skel = document.getElementById('skeleton');
            if (skel) skel.style.display = 'none';
        }

        function buildChatItem(chat, index) {
            var div = document.createElement('div');
            div.className = 'chat-item';
            div.style.animationDelay = (index * 0.04) + 's';

            var displayName = getChatDisplayName(chat);
            var otherUser = getChatOtherUser(chat);
            var isChannel = chat.type === 'channel';
            var isGroup = chat.type === 'group';

            // --- Avatar ---
            var avatarClass = 'avatar';
            var avatarText = '';

            if (isChannel) {
                avatarClass += ' channel-av';
                avatarText = 'üì¢';
            } else if (isGroup) {
                avatarClass += ' group-av';
                avatarText = 'üë•';
            } else {
                avatarText = otherUser ? getInitials(otherUser.name) : '?';
                if (otherUser && otherUser.melioPlus) {
                    avatarClass += ' plus-ring';
                }
            }

            // --- Online dot ---
            var dotHTML = '';
            if (otherUser) {
                dotHTML = '<span class="online-dot ' +
                    (otherUser.online ? 'on' : 'off') +
                    '"></span>';
            }

            // --- Verified badge ---
            var verifiedHTML = '';
            if (otherUser && otherUser.verified) {
                verifiedHTML = '<img src="https://cdn3d.iconscout.com/3d/premium/thumb/tick-3d-icon-png-download-10199917.png" class="verified-badge" alt="‚úì">';
            }
            // Channel: show owner's verified
            if (isChannel && chat.ownerId) {
                var owner = findUserById(chat.ownerId);
                if (owner && owner.verified) {
                    verifiedHTML = '<img src="https://cdn3d.iconscout.com/3d/premium/thumb/tick-3d-icon-png-download-10199917.png" class="verified-badge" alt="‚úì">';
                }
            }

            // --- Preview ---
            var previewHTML = '<span style="color:var(--text-muted)">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</span>';
            var timeStr = '';
            var statusHTML = '';

            if (chat.lastMessage) {
                var sender = findUserById(chat.lastMessage.senderId);
                var senderName = sender ? sender.name : '...';
                var msgText = chat.lastMessage.text;
                var isMulti = isChannel || isGroup;
                var isMine = chat.lastMessage.senderId === currentUser.id;

                // Truncate
                var maxLen = 35;
                var truncated = msgText.length > maxLen
                    ? msgText.slice(0, maxLen) + '‚Ä¶'
                    : msgText;

                if (isMulti) {
                    previewHTML =
                        '<span class="sender-label">' + senderName + ':</span> ' + truncated;
                } else if (isMine) {
                    previewHTML =
                        '<span class="sender-label">–í—ã:</span> ' + truncated;
                } else {
                    previewHTML = truncated;
                }

                timeStr = timeAgo(chat.lastMessage.createdAt);

                // Status checkmarks for own messages
                if (isMine && !isChannel) {
                    var st = chat.lastMessage.status;
                    if (st === 'seen') {
                        statusHTML = '<span class="msg-status seen">‚úì‚úì</span>';
                    } else if (st === 'delivered') {
                        statusHTML = '<span class="msg-status">‚úì‚úì</span>';
                    } else {
                        statusHTML = '<span class="msg-status">‚úì</span>';
                    }
                }
            }

            // --- Build HTML ---
            div.innerHTML =
                '<div class="' + avatarClass + '">' +
                    avatarText +
                    dotHTML +
                '</div>' +
                '<div class="chat-body">' +
                    '<div class="chat-row-top">' +
                        '<div class="chat-name">' +
                            '<span class="name-text">' + displayName + '</span>' +
                            verifiedHTML +
                        '</div>' +
                        '<span class="chat-time">' + timeStr + '</span>' +
                    '</div>' +
                    '<div class="chat-row-bottom">' +
                        '<div class="chat-preview">' + previewHTML + '</div>' +
                        statusHTML +
                    '</div>' +
                '</div>';

            // Click handler
            div.addEventListener('click', function () {
                localStorage.setItem('melio_active_chat', chat.id);
                goTo('melio-chat.html');
            });

            return div;
        }

        /* ============================================
           SEARCH
           ============================================ */

        function onSearch(value) {
            var clearBtn = document.getElementById('searchClear');
            if (value.length > 0) {
                clearBtn.classList.add('visible');
            } else {
                clearBtn.classList.remove('visible');
            }
            renderChatList(value);
        }

        function clearSearch() {
            var input = document.getElementById('searchInput');
            input.value = '';
            document.getElementById('searchClear').classList.remove('visible');
            renderChatList();
            input.focus();
        }

        /* ============================================
           NEW CHAT MODAL
           ============================================ */

        function openNewChatModal() {
            closeMenu();
            document.getElementById('newChatOverlay').classList.add('visible');
            renderModalUsers();
            var input = document.getElementById('modalSearchInput');
            input.value = '';
            setTimeout(function () {
                input.focus();
            }, 100);
        }

        function closeNewChatModal() {
            document.getElementById('newChatOverlay').classList.remove('visible');
        }

        function renderModalUsers(filter) {
            filter = filter || '';
            var list = document.getElementById('modalUserList');
            list.innerHTML = '';

            var filtered = [];
            for (var i = 0; i < allUsers.length; i++) {
                var user = allUsers[i];
                if (user.id === currentUser.id) continue;
                var matchName = user.name.toLowerCase().indexOf(filter.toLowerCase()) !== -1;
                var matchUsername = user.username &&
                    user.username.toLowerCase().indexOf(filter.toLowerCase()) !== -1;
                if (filter && !matchName && !matchUsername) continue;
                filtered.push(user);
            }

            if (filtered.length === 0) {
                list.innerHTML =
                    '<div class="empty-msg">' +
                    '<span class="empty-icon">üîç</span>' +
                    '–ù–∏–∫–æ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ' +
                    '</div>';
                return;
            }

            for (var j = 0; j < filtered.length; j++) {
                list.appendChild(buildModalUserItem(filtered[j]));
            }
        }

        function buildModalUserItem(user) {
            var btn = document.createElement('button');
            btn.className = 'modal-user-item';

            var verifiedHTML = '';
            if (user.verified) {
                verifiedHTML = '<img src="https://cdn3d.iconscout.com/3d/premium/thumb/tick-3d-icon-png-download-10199917.png" style="width:13px;height:13px;" alt="‚úì">';
            }

            var plusHTML = '';
            if (user.melioPlus) {
                plusHTML = '<span class="plus-badge" style="font-size:8px;">PLUS</span>';
            }

            var avatarClass = 'avatar avatar-sm';
            if (user.melioPlus) avatarClass += ' plus-ring';
            var dotClass = user.online ? 'on' : 'off';

            btn.innerHTML =
                '<div class="' + avatarClass + '">' +
                    getInitials(user.name) +
                    '<span class="online-dot ' + dotClass + '"></span>' +
                '</div>' +
                '<div class="mu-info">' +
                    '<div class="mu-name">' +
                        user.name + ' ' + verifiedHTML + ' ' + plusHTML +
                    '</div>' +
                    '<div class="mu-sub">' +
                        (user.username ? '@' + user.username : '–±–µ–∑ username') +
                        ' ¬∑ üíé ' + user.crystals.toLocaleString() +
                    '</div>' +
                '</div>';

            btn.addEventListener('click', function () {
                startNewChat(user.id);
            });

            return btn;
        }

        function filterModalUsers(value) {
            renderModalUsers(value);
        }

        async function startNewChat(otherUserId) {
            var chat = await api.createChat({
                type: 'private',
                name: null,
                members: [currentUser.id, otherUserId]
            });

            closeNewChatModal();

            var otherUser = findUserById(otherUserId);
            showToast(
                '–ß–∞—Ç —Å ' + (otherUser ? otherUser.name : '–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º') + ' —Å–æ–∑–¥–∞–Ω!',
                'success'
            );

            // Refresh
            myChats = await api.getChats(currentUser.id);
            renderChatList();

            // Open chat after delay
            setTimeout(function () {
                localStorage.setItem('melio_active_chat', chat.id);
                goTo('melio-chat.html');
            }, 500);
        }

        /* ============================================
           LOGOUT
           ============================================ */

        async function handleLogout() {
            closeMenu();
            await api.logout();
            showToast('–î–æ –≤—Å—Ç—Ä–µ—á–∏! üëã', 'info');
            setTimeout(function () {
                goTo('melio-auth.html');
            }, 600);
        }

        /* ============================================
           INIT
           ============================================ */

        document.addEventListener('DOMContentLoaded', async function () {
            // Load theme
            loadTheme();

            // Ensure Lunkes + Melio News exist
            ensureSpecialData();

            // Check auth
            currentUser = await api.getSession();
            if (!currentUser) {
                window.location.href = 'melio-auth.html';
                return;
            }

            // Load data
            allUsers = await api.getAllUsers();
            myChats = await api.getChats(currentUser.id);

            // Subscribe current user to Melio News if not already
            var chats = JSON.parse(localStorage.getItem('melio_chats') || '[]');
            var newsChannel = null;
            for (var i = 0; i < chats.length; i++) {
                if (chats[i].id === 'chat_melio_news') {
                    newsChannel = chats[i];
                    break;
                }
            }
            if (newsChannel && newsChannel.members.indexOf(currentUser.id) === -1) {
                newsChannel.members.push(currentUser.id);
                localStorage.setItem('melio_chats', JSON.stringify(chats));
                myChats = await api.getChats(currentUser.id);
            }

            // Render with skeleton delay
            setTimeout(function () {
                renderMenu();
                renderChatList();
                createParticles();
            }, 400);

            // Modal: close on backdrop click
            document.getElementById('newChatOverlay').addEventListener('click', function (e) {
                if (e.target.id === 'newChatOverlay') {
                    closeNewChatModal();
                }
            });

            // Keyboard shortcuts
            document.addEventListener('keydown', function (e) {
                // Escape
                if (e.key === 'Escape') {
                    closeNewChatModal();
                    closeMenu();
                }
                // Ctrl+K ‚Äî focus search
                if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                    e.preventDefault();
                    document.getElementById('searchInput').focus();
                }
                // Ctrl+N ‚Äî new chat
                if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                    e.preventDefault();
                    openNewChatModal();
                }
            });
        });
    </script>
</body>
</html>